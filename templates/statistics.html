{% extends "base.html" %}

{% block title %}Wahlkampf-Statistiken{% endblock %}

{% block head %}
<!-- Chart.js für Visualisierungen -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .stats-card {
        background: linear-gradient(135deg, var(--spd-white) 0%, var(--spd-light-gray) 100%);
        border: none;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(227, 0, 15, 0.1);
        transition: transform 0.3s;
    }

    .stats-card:hover {
        transform: translateY(-5px);
    }

    .stats-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--spd-red);
        margin-bottom: 0.5rem;
    }

    .stats-label {
        color: var(--spd-gray);
        font-size: 1rem;
        margin-bottom: 0;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 2rem;
    }

    .top-routes-list {
        list-style: none;
        padding: 0;
    }

    .top-routes-list li {
        padding: 1rem;
        margin-bottom: 0.5rem;
        background-color: var(--spd-white);
        border-radius: 8px;
        border-left: 4px solid var(--spd-red);
        transition: transform 0.2s;
    }

    .top-routes-list li:hover {
        transform: translateX(5px);
    }

    .city-stats-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 0.5rem;
    }

    .city-stats-table th {
        color: var(--spd-dark-red);
        font-weight: 600;
        padding: 1rem;
        text-align: left;
    }

    .city-stats-table td {
        background-color: var(--spd-white);
        padding: 1rem;
        border-radius: 0;
    }

    .city-stats-table tr td:first-child {
        border-radius: 8px 0 0 8px;
        border-left: 4px solid var(--spd-red);
    }

    .city-stats-table tr td:last-child {
        border-radius: 0 8px 8px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Wahlkampf-Statistiken</h1>

    <!-- Übersichtskarten -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <p class="stats-number">{{ total_routes }}</p>
                <p class="stats-label">Aktive Routen</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <p class="stats-number">{{ total_volunteers }}</p>
                <p class="stats-label">Freiwillige</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <p class="stats-number">{{ total_registrations }}</p>
                <p class="stats-label">Gebuchte Termine</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <p class="stats-number">{{ avg_mobilization }}/3</p>
                <p class="stats-label">Ø Mobilisierungsindex</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Stadtstatistiken -->
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-city"></i> Statistiken nach Stadt
                    </h5>
                    <div class="table-responsive">
                        <table class="city-stats-table">
                            <thead>
                                <tr>
                                    <th>Stadt</th>
                                    <th>Routen</th>
                                    <th>Ø Mobilisierung</th>
                                    <th>Ø Überzeugung</th>
                                    <th>Haushalte</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in city_stats %}
                                <tr>
                                    <td>{{ stat.city }}</td>
                                    <td>{{ stat.route_count }}</td>
                                    <td>{{ "%.2f"|format(stat.avg_mobilization) }}/3</td>
                                    <td>{{ "%.2f"|format(stat.avg_conviction) }}/3</td>
                                    <td>{{ stat.total_households or 0 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Visualisierung -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-bar"></i> Mobilisierungspotenzial nach Stadt
                    </h5>
                    <div class="chart-container">
                        <canvas id="cityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Routen -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-star"></i> Top 5 Routen
                    </h5>
                    <ul class="top-routes-list">
                        {% for route in top_routes %}
                        <li>
                            <strong>{{ route.street }} {{ route.house_numbers }}</strong><br>
                            <small class="text-muted">{{ route.city }}</small>
                            <div class="progress mt-2" style="height: 10px;">
                                {% set width = (route.mobilization_index/3*100)|round %}
                                <div class="progress-bar bg-spd" 
                                     role="progressbar" 
                                     style="width: {{ width }}%" 
                                     aria-valuenow="{{ width }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                            <small class="text-muted">
                                Mobilisierungsindex: {{ route.mobilization_index }}/3
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Daten für das Diagramm vorbereiten
    const cityData = {{ city_stats|tojson }};
    const cities = cityData.map(stat => stat.city);
    const mobilizationData = cityData.map(stat => stat.avg_mobilization);
    
    // Stadt-Diagramm erstellen
    const ctx = document.getElementById('cityChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: cities,
            datasets: [{
                label: 'Durchschnittlicher Mobilisierungsindex',
                data: mobilizationData,
                backgroundColor: '#E3000F',
                borderColor: '#A41D21',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 3,
                    ticks: {
                        stepSize: 0.5
                    }
                }
            }
        }
    });
});
</script>
{% endblock %} 