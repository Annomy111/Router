{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <h2>{{ route.street }} {{ route.house_numbers }}</h2>
            <p><strong>Stadt:</strong> {{ route.city }}</p>
            <p><strong>Bezirk:</strong> {{ route.district }}</p>
            <p><strong>PLZ:</strong> {{ route.zip_code }}</p>
            <p><strong>Treffpunkt:</strong> {{ route.meeting_point }}</p>
            
            <!-- Statistiken -->
            <div class="stats-container mt-4">
                <h4>Statistiken</h4>
                <div class="row">
                    <div class="col-6">
                        <div class="stat-box">
                            <i class="fas fa-home"></i>
                            <span class="stat-value">{{ route.households }}</span>
                            <span class="stat-label">Haushalte</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-box">
                            <i class="fas fa-percentage"></i>
                            <span class="stat-value">{{ route.rental_percentage }}%</span>
                            <span class="stat-label">Mietanteil</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registrierungsbutton -->
            <div class="mt-4">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registrationModal">
                    Als Freiwilliger registrieren
                </button>
            </div>
        </div>
        
        <!-- Google Maps -->
        <div class="col-md-6">
            <div id="map" style="height: 400px;"></div>
        </div>
    </div>
</div>

<!-- Registrierungsformular -->
<div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registrationModalLabel">Als Freiwilliger registrieren</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <form id="registrationForm" class="needs-validation" novalidate>
                    <!-- Schritt 1: Persönliche Daten -->
                    <div class="wizard-step active">
                        <h6 class="mb-3">Persönliche Daten</h6>
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" required autocomplete="name">
                            <div class="invalid-feedback">
                                Bitte geben Sie Ihren Namen ein.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">E-Mail</label>
                            <input type="email" class="form-control" id="email" name="email" required autocomplete="email">
                            <div class="invalid-feedback">
                                Bitte geben Sie eine gültige E-Mail-Adresse ein.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Telefon</label>
                            <input type="tel" class="form-control" id="phone" name="phone" required autocomplete="tel">
                            <div class="invalid-feedback">
                                Bitte geben Sie Ihre Telefonnummer ein.
                            </div>
                        </div>
                    </div>

                    <!-- Schritt 2: Zeitauswahl -->
                    <div class="wizard-step">
                        <h6 class="mb-3">Zeitauswahl</h6>
                        <div class="mb-3">
                            <label for="date" class="form-label">Datum</label>
                            <input type="date" class="form-control" id="date" name="date" required autocomplete="off">
                            <div class="invalid-feedback">
                                Bitte wählen Sie ein Datum aus.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="timeSlot" class="form-label">Zeitfenster</label>
                            <select class="form-select" id="timeSlot" name="timeSlot" required autocomplete="off">
                                <option value="">Bitte wählen...</option>
                                <option value="morning">Vormittag (9:00 - 12:00)</option>
                                <option value="afternoon">Nachmittag (14:00 - 17:00)</option>
                                <option value="evening">Abend (17:00 - 20:00)</option>
                            </select>
                            <div class="invalid-feedback">
                                Bitte wählen Sie ein Zeitfenster aus.
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary btn-prev d-none">Zurück</button>
                        <button type="button" class="btn btn-primary btn-next">Weiter</button>
                        <button type="submit" class="btn btn-success d-none">Registrierung abschließen</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps Script -->
<script>
function initMap() {
    const routeLocation = { lat: {{ route.lat }}, lng: {{ route.lon }} };
    const meetingPoint = { lat: {{ route.meeting_point_lat }}, lng: {{ route.meeting_point_lon }} };
    
    const map = new google.maps.Map(document.getElementById('map'), {
        zoom: 16,
        center: routeLocation
    });
    
    // Route marker
    new google.maps.Marker({
        position: routeLocation,
        map: map,
        title: '{{ route.street }} {{ route.house_numbers }}'
    });
    
    // Meeting point marker
    new google.maps.Marker({
        position: meetingPoint,
        map: map,
        title: 'Treffpunkt: {{ route.meeting_point }}',
        icon: {
            url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
        }
    });
}
</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ config['GOOGLE_MAPS_KEY'] }}&callback=initMap">
</script>

<!-- Form Handling Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('registrationForm');
    const nextBtn = document.querySelector('.btn-next');
    const prevBtn = document.querySelector('.btn-prev');
    const submitBtn = document.querySelector('button[type="submit"]');
    const steps = document.querySelectorAll('.wizard-step');
    let currentStep = 0;

    function showStep(stepIndex) {
        steps.forEach((step, index) => {
            step.classList.toggle('active', index === stepIndex);
        });
        
        prevBtn.classList.toggle('d-none', stepIndex === 0);
        nextBtn.classList.toggle('d-none', stepIndex === steps.length - 1);
        submitBtn.classList.toggle('d-none', stepIndex !== steps.length - 1);
    }

    nextBtn.addEventListener('click', () => {
        if (validateCurrentStep()) {
            currentStep++;
            showStep(currentStep);
        }
    });

    prevBtn.addEventListener('click', () => {
        currentStep--;
        showStep(currentStep);
    });

    function validateCurrentStep() {
        const currentStepElement = steps[currentStep];
        const inputs = currentStepElement.querySelectorAll('input[required], select[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!input.value) {
                isValid = false;
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
            }
        });

        return isValid;
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!validateCurrentStep()) return;

        const formData = {
            route_id: {{ route.id }},
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            date: document.getElementById('date').value,
            time_slot: document.getElementById('timeSlot').value
        };

        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (result.success) {
                alert('Registrierung erfolgreich!');
                window.location.reload();
            } else {
                alert('Fehler bei der Registrierung: ' + result.error);
            }
        } catch (error) {
            alert('Ein Fehler ist aufgetreten: ' + error);
        }
    });
});
</script>
{% endblock %} 