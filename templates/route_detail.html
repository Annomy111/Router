{% extends "base.html" %}

{% block title %}{{ route.street }} - Details{% endblock %}

{% block head %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap JavaScript Bundle mit Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Google Maps JavaScript API - Lazy Loading -->
<script>
    // Lazy Load Google Maps
    function loadGoogleMaps() {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&libraries=places,directions&callback=initMap`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    }
    // Load Maps when page is fully loaded
    window.addEventListener('load', loadGoogleMaps);
</script>

<style>
    /* SPD Brand Colors */
    :root {
        --spd-red: #E3000F;
        --spd-dark-red: #A41D21;
        --spd-gray: #878787;
        --spd-light-gray: #f5f5f5;
        --spd-white: #ffffff;
        
        /* Animation Constants */
        --transition-speed: 0.3s;
    }

    /* Critical Path CSS */
    .route-detail-card {
        background: var(--spd-white);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(227, 0, 15, 0.1);
        margin-bottom: 1.5rem;
        padding: 2rem;
        transition: transform var(--transition-speed) ease;
    }

    .route-header {
        margin-bottom: 2rem;
    }

    .route-header h1 {
        color: var(--spd-dark-red);
        margin-bottom: 0.5rem;
    }

    .route-header p {
        color: var(--spd-gray);
        font-size: 1.1rem;
        margin-bottom: 0;
    }

    .route-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--spd-light-gray);
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
    }

    .stat-card h3 {
        color: var(--spd-dark-red);
        margin-bottom: 0.5rem;
        font-size: 1.2rem;
    }

    .stat-card p {
        color: var(--spd-gray);
        margin-bottom: 0;
        font-size: 2rem;
        font-weight: 600;
    }

    .progress {
        height: 20px;
        background-color: var(--spd-light-gray);
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    .progress-bar {
        background-color: var(--spd-red);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--spd-white);
        font-weight: 600;
        width: 0;
    }

    .map-container {
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .registration-section {
        margin-top: 3rem;
    }

    .registration-section h2 {
        color: var(--spd-dark-red);
        margin-bottom: 1.5rem;
    }

    .registration-card {
        background: var(--spd-white);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .registration-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
    }

    /* Loading Animation */
    .loading-spinner {
        display: none;
        width: 50px;
        height: 50px;
        border: 5px solid var(--spd-light-gray);
        border-top: 5px solid var(--spd-red);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Form Validation Styles */
    .form-control.is-invalid {
        border-color: var(--spd-red);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23E3000F'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23E3000F' stroke='none'/%3e%3c/svg%3e");
    }

    .invalid-feedback {
        color: var(--spd-red);
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    /* Toast Notification */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1060;
    }

    .toast {
        background: var(--spd-white);
        border-left: 4px solid var(--spd-red);
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Routendetails -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="route-detail-card">
                        <div class="route-header">
                            <h1>{{ route.street }}</h1>
                            <p>{{ route.house_numbers }}, {{ route.zip_code }} {{ route.city }}</p>
                        </div>

                        <div class="route-stats">
                            <div class="stat-card">
                                <h3>Mobilisierungsindex</h3>
                                <div class="progress">
                                    <div class="progress-bar" 
                                         role="progressbar" 
                                         style="width: {{ (route.mobilization_index/3*100)|round }}%">
                                        {{ route.mobilization_index }}/3
                                    </div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <h3>Überzeugungsindex</h3>
                                <div class="progress">
                                    <div class="progress-bar" 
                                         role="progressbar" 
                                         style="width: {{ (route.conviction_index/3*100)|round }}%">
                                        {{ route.conviction_index }}/3
                                    </div>
                                </div>
                            </div>
                            {% if route.households %}
                            <div class="stat-card">
                                <h3>Haushalte</h3>
                                <p>{{ route.households }}</p>
                            </div>
                            {% endif %}
                            {% if route.rental_percentage %}
                            <div class="stat-card">
                                <h3>Mietquote</h3>
                                <p>{{ "%.1f"|format(route.rental_percentage) }}%</p>
                            </div>
                            {% endif %}
                        </div>

                        <div class="highlight-box">
                            <h5><i class="fas fa-route text-primary"></i> Routendetails</h5>
                            <p class="lead">
                                Diese Route wurde für Jan Dierens Haustürwahlkampf 2025 optimiert.
                                Sie umfasst {{ route.house_numbers }} und ist für einen 2-stündigen Einsatz im Zweierteam ausgelegt.
                                Gemeinsam sprechen wir mit den Menschen über bezahlbares Wohnen, gute Arbeit und die Zukunft unserer Region.
                            </p>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-clock text-info"></i> Zeitbedarf: 2 Stunden
                                        </li>
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-door-open text-success"></i> Geplante Gespräche: 10-15 Haushalte
                                        </li>
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-walking text-primary"></i> Empfohlene Gehrichtung: 
                                            <br>von {{ route.house_numbers.split('-')[0] }} 
                                            bis {{ route.house_numbers.split('-')[1] }}
                                        </li>
                                        {% if route.meeting_point %}
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-map-marker-alt text-danger"></i> Treffpunkt: 
                                            <br>{{ route.meeting_point }}
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-3">Beste Besuchszeiten:</h6>
                                    <span class="time-slot-badge">
                                        <i class="fas fa-sun"></i> Werktags 17-19 Uhr
                                    </span>
                                    <span class="time-slot-badge">
                                        <i class="fas fa-coffee"></i> Samstags 11-13 Uhr
                                    </span>
                                    <div class="mt-4">
                                        <p class="text-muted">
                                            <i class="fas fa-info-circle"></i> 
                                            Du erhältst vor deinem Einsatz eine kurze Einführung und alle wichtigen Materialien. 
                                            Jan wird regelmäßig selbst mit dabei sein!
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="registration-section">
                            <h2>Registrierungen</h2>
                            {% if registrations %}
                            {% for reg in registrations %}
                            <div class="registration-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1">{{ reg.volunteer.name }}</h5>
                                        <p class="text-muted mb-0">{{ reg.date.strftime('%d.%m.%Y') }} - {{ reg.time_slot }}</p>
                                    </div>
                                    <span class="badge {% if reg.status == 'geplant' %}bg-warning{% elif reg.status == 'abgeschlossen' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ reg.status }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <p class="text-muted">Noch keine Registrierungen für diese Route.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Google Maps Container -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div id="map" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Aktionsbuttons -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">Aktionen</h5>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registrationModal">
                            Route reservieren
                        </button>
                        <button class="btn btn-outline-secondary" onclick="window.history.back()">
                            Zurück zur Übersicht
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="loading-spinner"></div>

<!-- Toast Container -->
<div class="toast-container">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Mitteilung</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Schließen"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

<!-- Registrierungs-Modal -->
<div class="modal fade" id="registrationModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registrationModalLabel">Route reservieren</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <form id="registrationForm" onsubmit="handleRegistration(event)" novalidate>
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" name="name" required 
                               pattern="[A-Za-zÄäÖöÜüß\s-]{2,50}" 
                               title="Bitte geben Sie einen gültigen Namen ein (2-50 Zeichen)">
                        <div class="invalid-feedback">
                            Bitte geben Sie einen gültigen Namen ein (2-50 Zeichen).
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">E-Mail</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                        <div class="invalid-feedback">
                            Bitte geben Sie eine gültige E-Mail-Adresse ein.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Telefon (optional)</label>
                        <input type="tel" class="form-control" id="phone" name="phone" 
                               pattern="[0-9+\s-]{6,20}">
                        <div class="invalid-feedback">
                            Bitte geben Sie eine gültige Telefonnummer ein.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="date" class="form-label">Datum</label>
                        <input type="date" class="form-control" id="date" name="date" required>
                        <div class="invalid-feedback">
                            Bitte wählen Sie ein gültiges Datum aus.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="timeSlot" class="form-label">Zeitfenster</label>
                        <select class="form-select" id="timeSlot" name="timeSlot" required>
                            <option value="">Bitte wählen...</option>
                            <option value="17-19 Uhr">Werktags 17-19 Uhr</option>
                            <option value="11-13 Uhr">Samstags 11-13 Uhr</option>
                        </select>
                        <div class="invalid-feedback">
                            Bitte wählen Sie ein Zeitfenster aus.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="submit" class="btn btn-primary" id="submitButton">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Reservieren
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Konstanten
    const MAP_DEFAULT_LAT = 51.4512;
    const MAP_DEFAULT_LON = 6.6382;
    const TOAST_DURATION = 5000;
    const FORM_SUBMISSION_DELAY = 300;

    // Map Variablen
    let map;
    let directionsService;
    let directionsRenderer;
    let registrationModal;
    let notificationToast;

    // Event Listener für DOM-Laden
    document.addEventListener('DOMContentLoaded', function() {
        initializeComponents();
        setupEventListeners();
    });

    // Komponenten initialisieren
    function initializeComponents() {
        // Modal initialisieren
        registrationModal = new bootstrap.Modal(document.getElementById('registrationModal'), {
            backdrop: 'static',
            keyboard: false
        });

        // Toast initialisieren
        notificationToast = new bootstrap.Toast(document.getElementById('notificationToast'), {
            autohide: true,
            delay: TOAST_DURATION
        });
    }

    // Event Listener einrichten
    function setupEventListeners() {
        // Form-Handler
        const form = document.getElementById('registrationForm');
        form.addEventListener('submit', handleRegistration);

        // Modal Events
        document.getElementById('registrationModal').addEventListener('hidden.bs.modal', handleModalHidden);
        
        // Input Validation
        form.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', () => validateInput(input));
        });
    }

    // Input Validierung
    function validateInput(input) {
        if (input.validity.valid) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
        } else {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
        }
    }

    // Form Validierung
    function validateForm(form) {
        let isValid = true;
        form.querySelectorAll('input, select').forEach(input => {
            if (!input.validity.valid) {
                isValid = false;
                input.classList.add('is-invalid');
            }
        });
        return isValid;
    }

    // Modal verstecken Event Handler
    function handleModalHidden() {
        const form = document.getElementById('registrationForm');
        form.reset();
        form.querySelectorAll('.is-invalid, .is-valid').forEach(input => {
            input.classList.remove('is-invalid', 'is-valid');
        });
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }

    // Toast Benachrichtigung anzeigen
    function showNotification(message, type = 'success') {
        const toast = document.getElementById('notificationToast');
        toast.querySelector('.toast-body').textContent = message;
        toast.classList.remove('bg-success', 'bg-danger');
        toast.classList.add(type === 'success' ? 'bg-success' : 'bg-danger');
        notificationToast.show();
    }

    // Registrierungs-Handler
    async function handleRegistration(event) {
        event.preventDefault();
        const form = event.target;
        
        // Form validieren
        if (!validateForm(form)) {
            return;
        }

        // UI-Elemente aktualisieren
        const submitButton = form.querySelector('button[type="submit"]');
        const spinner = submitButton.querySelector('.spinner-border');
        submitButton.disabled = true;
        spinner.classList.remove('d-none');

        const formData = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            date: document.getElementById('date').value,
            time_slot: document.getElementById('timeSlot').value,
            route_id: {{ route.id }}
        };

        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                registrationModal.hide();
                showNotification('Registrierung erfolgreich! Sie erhalten eine Bestätigungs-E-Mail.');
                setTimeout(() => window.location.reload(), FORM_SUBMISSION_DELAY);
            } else {
                showNotification(data.error || 'Ein Fehler ist aufgetreten.', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.', 'error');
        } finally {
            submitButton.disabled = false;
            spinner.classList.add('d-none');
        }
    }

    // Map initialisieren
    function initMap() {
        const routeCenter = {
            lat: {{ route.lat|default(MAP_DEFAULT_LAT) }},
            lng: {{ route.lon|default(MAP_DEFAULT_LON) }}
        };
        
        try {
            setupMap(routeCenter);
            setupRouteMarker(routeCenter);
            setupMeetingPoint();
            setupDirections();
        } catch (error) {
            console.error('Error initializing map:', error);
            showNotification('Fehler beim Laden der Karte.', 'error');
        }
    }

    // Map Setup
    function setupMap(center) {
        const mapOptions = {
            zoom: 15,
            center: center,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            styles: [{
                featureType: "poi",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
            }]
        };
        
        map = new google.maps.Map(document.getElementById('map'), mapOptions);
    }

    // Route Marker Setup
    function setupRouteMarker(position) {
        const routeMarker = new google.maps.Marker({
            position: position,
            map: map,
            title: '{{ route.street }}',
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: "#E3000F",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "#ffffff"
            }
        });

        const routeInfo = new google.maps.InfoWindow({
            content: `
                <div style="padding: 10px;">
                    <h6 style="color: #A41D21; margin-bottom: 5px;">{{ route.street }}</h6>
                    <p style="margin: 0;">{{ route.house_numbers }}, {{ route.zip_code }} {{ route.city }}</p>
                </div>
            `
        });

        routeMarker.addListener('click', () => routeInfo.open(map, routeMarker));
    }

    // Meeting Point Setup
    function setupMeetingPoint() {
        {% if route.meeting_point and route.meeting_point_lat and route.meeting_point_lon %}
        const meetingPoint = new google.maps.Marker({
            position: {
                lat: {{ route.meeting_point_lat }},
                lng: {{ route.meeting_point_lon }}
            },
            map: map,
            title: 'Treffpunkt',
            icon: {
                path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                scale: 6,
                fillColor: "#E3000F",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "#ffffff"
            }
        });

        const meetingPointInfo = new google.maps.InfoWindow({
            content: `
                <div style="padding: 10px;">
                    <h6 style="color: #A41D21; margin-bottom: 5px;">Treffpunkt</h6>
                    <p style="margin: 0;">{{ route.meeting_point }}</p>
                </div>
            `
        });

        meetingPoint.addListener('click', () => meetingPointInfo.open(map, meetingPoint));
        {% endif %}
    }

    // Directions Setup
    function setupDirections() {
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
                strokeColor: '#E3000F',
                strokeOpacity: 0.8,
                strokeWeight: 5
            }
        });

        const numbers = '{{ route.house_numbers }}'.split('-');
        const startNum = parseInt(numbers[0].trim(), 10);
        const endNum = parseInt(numbers[1].trim(), 10);
        const startAddress = `{{ route.street }} ${startNum}, {{ route.zip_code }} {{ route.city }}, Germany`;
        const endAddress = `{{ route.street }} ${endNum}, {{ route.zip_code }} {{ route.city }}, Germany`;

        calculateRoute(startAddress, endAddress);
    }

    // Route berechnen
    function calculateRoute(startAddress, endAddress) {
        directionsService.route({
            origin: startAddress,
            destination: endAddress,
            travelMode: google.maps.TravelMode.WALKING
        }, (response, status) => {
            if (status === 'OK') {
                directionsRenderer.setDirections(response);
                const coordinates = response.routes[0].overview_path.map(point => ({
                    lat: point.lat(),
                    lng: point.lng()
                }));
                saveRouteCoordinates(coordinates);
            } else {
                console.error('Directions request failed:', status);
                showNotification('Fehler beim Laden der Route.', 'error');
            }
        });
    }

    // Route Koordinaten speichern
    async function saveRouteCoordinates(coordinates) {
        try {
            await fetch('/api/routes/{{ route.id }}/path', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ coordinates: coordinates })
            });
        } catch (error) {
            console.error('Error saving route coordinates:', error);
        }
    }
</script>
{% endblock %} 