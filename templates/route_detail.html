{% extends "base.html" %}

{% block title %}{{ route.street }} - Details{% endblock %}

{% block head %}
<!-- Google Maps JavaScript API -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&libraries=places,directions"></script>

<style>
    :root {
        --spd-red: #E3000F;
        --spd-dark-red: #A41D21;
        --spd-gray: #878787;
        --spd-light-gray: #f5f5f5;
        --spd-white: #ffffff;
    }

    .route-detail-card {
        background: var(--spd-white);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(227, 0, 15, 0.1);
        margin-bottom: 1.5rem;
        padding: 2rem;
    }

    .progress-bar {
        background-color: var(--spd-red);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--spd-white);
        font-weight: 600;
        width: 0;
    }

    .progress {
        height: 20px;
        background-color: var(--spd-light-gray);
        border-radius: 10px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Routendetails -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="route-detail-card">
                        <div class="route-header">
                            <h1>{{ route.street }}</h1>
                            <p>{{ route.house_numbers }}, {{ route.zip_code }} {{ route.city }}</p>
                        </div>

                        <div class="route-stats">
                            <div class="stat-card">
                                <h3>Mobilisierungsindex</h3>
                                <div class="progress">
                                    <div class="progress-bar" 
                                         role="progressbar" 
                                         style="width: {{ (route.mobilization_index/3*100)|round }}%">
                                        {{ route.mobilization_index }}/3
                                    </div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <h3>Überzeugungsindex</h3>
                                <div class="progress">
                                    <div class="progress-bar" 
                                         role="progressbar" 
                                         style="width: {{ (route.conviction_index/3*100)|round }}%">
                                        {{ route.conviction_index }}/3
                                    </div>
                                </div>
                            </div>
                            {% if route.households %}
                            <div class="stat-card">
                                <h3>Haushalte</h3>
                                <p>{{ route.households }}</p>
                            </div>
                            {% endif %}
                            {% if route.rental_percentage %}
                            <div class="stat-card">
                                <h3>Mietquote</h3>
                                <p>{{ "%.1f"|format(route.rental_percentage) }}%</p>
                            </div>
                            {% endif %}
                        </div>

                        <div class="highlight-box">
                            <h5><i class="fas fa-route text-primary"></i> Routendetails</h5>
                            <p class="lead">
                                Diese Route wurde für Jan Dierens Haustürwahlkampf 2025 optimiert.
                                Sie umfasst {{ route.house_numbers }} und ist für einen 2-stündigen Einsatz im Zweierteam ausgelegt.
                                Gemeinsam sprechen wir mit den Menschen über bezahlbares Wohnen, gute Arbeit und die Zukunft unserer Region.
                            </p>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-clock text-info"></i> Zeitbedarf: 2 Stunden
                                        </li>
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-door-open text-success"></i> Geplante Gespräche: 10-15 Haushalte
                                        </li>
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-walking text-primary"></i> Empfohlene Gehrichtung: 
                                            <br>von {{ route.house_numbers.split('-')[0] }} 
                                            bis {{ route.house_numbers.split('-')[1] }}
                                        </li>
                                        {% if route.meeting_point %}
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-map-marker-alt text-danger"></i> Treffpunkt: 
                                            <br>{{ route.meeting_point }}
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-3">Beste Besuchszeiten:</h6>
                                    <span class="time-slot-badge">
                                        <i class="fas fa-sun"></i> Werktags 17-19 Uhr
                                    </span>
                                    <span class="time-slot-badge">
                                        <i class="fas fa-coffee"></i> Samstags 11-13 Uhr
                                    </span>
                                    <div class="mt-4">
                                        <p class="text-muted">
                                            <i class="fas fa-info-circle"></i> 
                                            Du erhältst vor deinem Einsatz eine kurze Einführung und alle wichtigen Materialien. 
                                            Jan wird regelmäßig selbst mit dabei sein!
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="registration-section">
                            <h2>Registrierungen</h2>
                            {% if registrations %}
                            {% for reg in registrations %}
                            <div class="registration-card">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1">{{ reg.volunteer.name }}</h5>
                                        <p class="text-muted mb-0">{{ reg.date.strftime('%d.%m.%Y') }} - {{ reg.time_slot }}</p>
                                    </div>
                                    <span class="badge {% if reg.status == 'geplant' %}bg-warning{% elif reg.status == 'abgeschlossen' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ reg.status }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <p class="text-muted">Noch keine Registrierungen für diese Route.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Google Maps Container -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div id="map" style="height: 400px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Aktionsbuttons -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">Aktionen</h5>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registrationModal">
                            Route reservieren
                        </button>
                        <button class="btn btn-outline-secondary" onclick="window.history.back()">
                            Zurück zur Übersicht
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Registrierungs-Modal -->
<div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registrationModalLabel">Route reservieren</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <form id="registrationForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">E-Mail</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Telefon (optional)</label>
                        <input type="tel" class="form-control" id="phone" name="phone">
                    </div>
                    <div class="mb-3">
                        <label for="date" class="form-label">Datum</label>
                        <input type="date" class="form-control" id="date" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="timeSlot" class="form-label">Zeitfenster</label>
                        <select class="form-select" id="timeSlot" name="timeSlot" required>
                            <option value="">Bitte wählen...</option>
                            <option value="17-19 Uhr">Werktags 17-19 Uhr</option>
                            <option value="11-13 Uhr">Samstags 11-13 Uhr</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="submitRegistration()">Reservieren</button>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps Script -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=initMap" async defer></script>
<script>
    function initMap() {
        var routeCenter = {
            lat: {{ route.lat|default(51.4512) }},
            lng: {{ route.lon|default(6.6382) }}
        };
        
        var mapOptions = {
            zoom: 15,
            center: routeCenter,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            styles: [{
                featureType: "poi",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
            }]
        };
        
        var map = new google.maps.Map(document.getElementById('map'), mapOptions);
        
        var routeMarker = new google.maps.Marker({
            position: routeCenter,
            map: map,
            title: '{{ route.street }}',
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: "#E3000F",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "#ffffff"
            }
        });

        var routeInfo = new google.maps.InfoWindow({
            content: '<div style="padding: 10px;">' +
                    '<h6 style="color: #A41D21; margin-bottom: 5px;">{{ route.street }}</h6>' +
                    '<p style="margin: 0;">{{ route.house_numbers }}, {{ route.zip_code }} {{ route.city }}</p>' +
                    '</div>'
        });

        routeMarker.addListener('click', function() {
            routeInfo.open(map, routeMarker);
        });
        
        {% if route.meeting_point and route.meeting_point_lat and route.meeting_point_lon %}
        var meetingPoint = new google.maps.Marker({
            position: {
                lat: {{ route.meeting_point_lat }},
                lng: {{ route.meeting_point_lon }}
            },
            map: map,
            title: 'Treffpunkt',
            icon: {
                path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                scale: 6,
                fillColor: "#E3000F",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "#ffffff"
            }
        });
        
        var meetingPointInfo = new google.maps.InfoWindow({
            content: '<div style="padding: 10px;">' +
                    '<h6 style="color: #A41D21; margin-bottom: 5px;">Treffpunkt</h6>' +
                    '<p style="margin: 0;">{{ route.meeting_point }}</p>' +
                    '</div>'
        });
        
        meetingPoint.addListener('click', function() {
            meetingPointInfo.open(map, meetingPoint);
        });
        {% endif %}
        
        var directionsService = new google.maps.DirectionsService();
        var directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
                strokeColor: '#E3000F',
                strokeOpacity: 0.8,
                strokeWeight: 5
            }
        });

        var numbers = '{{ route.house_numbers }}'.split('-');
        var startNum = parseInt(numbers[0].trim());
        var endNum = parseInt(numbers[1].trim());
        var startAddress = '{{ route.street }} ' + startNum + ', {{ route.zip_code }} {{ route.city }}, Germany';
        var endAddress = '{{ route.street }} ' + endNum + ', {{ route.zip_code }} {{ route.city }}, Germany';

        directionsService.route({
            origin: startAddress,
            destination: endAddress,
            travelMode: google.maps.TravelMode.WALKING
        }, function(response, status) {
            if (status === 'OK') {
                directionsRenderer.setDirections(response);
                var path = response.routes[0].overview_path;
                var coordinates = path.map(function(point) {
                    return {
                        lat: point.lat(),
                        lng: point.lng()
                    };
                });
                
                fetch('/api/routes/{{ route.id }}/path', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ coordinates: coordinates })
                });
            } else {
                console.error('Directions request failed due to ' + status);
            }
        });
    }

    function submitRegistration() {
        var formData = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            date: document.getElementById('date').value,
            time_slot: document.getElementById('timeSlot').value,
            route_id: {{ route.id }}
        };

        fetch('/api/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                alert('Registrierung erfolgreich! Sie erhalten eine Bestätigungs-E-Mail.');
                location.reload();
            } else {
                alert(data.error || 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.');
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            alert('Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.');
        });
    }
</script>
{% endblock %} 