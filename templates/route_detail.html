{% extends "base.html" %}

{% block title %}{{ route.street }} - Details{% endblock %}

{% block head %}
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap JavaScript Bundle mit Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Google Maps JavaScript API - Lazy Loading -->
<script>
    // Lazy Load Google Maps
    function loadGoogleMaps() {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&libraries=places,directions&callback=initMap`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
    }
    // Load Maps when page is fully loaded
    window.addEventListener('load', loadGoogleMaps);
</script>

<style>
    /* SPD Brand Colors */
    :root {
        --spd-red: #E3000F;
        --spd-dark-red: #A41D21;
        --spd-gray: #878787;
        --spd-light-gray: #f5f5f5;
        --spd-white: #ffffff;
        
        /* Animation Constants */
        --transition-speed: 0.3s;
    }

    /* Critical Path CSS */
    .route-detail-card {
        background: var(--spd-white);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(227, 0, 15, 0.1);
        margin-bottom: 1.5rem;
        padding: 2rem;
        transition: transform var(--transition-speed) ease;
    }

    .route-header {
        margin-bottom: 2rem;
    }

    .route-header h1 {
        color: var(--spd-dark-red);
        margin-bottom: 0.5rem;
    }

    .route-header p {
        color: var(--spd-gray);
        font-size: 1.1rem;
        margin-bottom: 0;
    }

    .route-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--spd-light-gray);
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
    }

    .stat-card h3 {
        color: var(--spd-dark-red);
        margin-bottom: 0.5rem;
        font-size: 1.2rem;
    }

    .stat-card p {
        color: var(--spd-gray);
        margin-bottom: 0;
        font-size: 2rem;
        font-weight: 600;
    }

    .progress {
        height: 20px;
        background-color: var(--spd-light-gray);
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    .progress-bar {
        background-color: var(--spd-red);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--spd-white);
        font-weight: 600;
        width: 0;
    }

    .map-container {
        position: relative;
        width: 100%;
        height: 50vh;
        min-height: 300px;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .map-fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1050;
        border-radius: 0;
    }
    
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }
    
    .map-control-btn {
        background: white;
        border: none;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        cursor: pointer;
        margin-left: 5px;
    }
    
    .map-control-btn:hover {
        background: #f8f9fa;
    }
    
    @media (max-width: 768px) {
        .map-container {
            height: 40vh;
        }
    }

    .registration-section {
        margin-top: 3rem;
    }

    .registration-section h2 {
        color: var(--spd-dark-red);
        margin-bottom: 1.5rem;
    }

    .registration-card {
        background: var(--spd-white);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .registration-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
    }

    /* Loading Animation */
    .loading-spinner {
        display: none;
        width: 50px;
        height: 50px;
        border: 5px solid var(--spd-light-gray);
        border-top: 5px solid var(--spd-red);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Form Validation Styles */
    .form-control.is-invalid {
        border-color: var(--spd-red);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23E3000F'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23E3000F' stroke='none'/%3e%3c/svg%3e");
    }

    .invalid-feedback {
        color: var(--spd-red);
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    /* Toast Notification */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1060;
    }

    .toast {
        background: var(--spd-white);
        border-left: 4px solid var(--spd-red);
    }

    /* Modal Styles */
    .modal-backdrop {
        display: none !important;
    }

    .modal {
        background: none !important;
    }

    .modal-dialog {
        margin: 1.75rem auto;
    }

    .modal-content {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    /* Index Styles */
    .index-container {
        margin-bottom: 1.5rem;
    }
    
    .index-label {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .index-icon {
        margin-right: 0.5rem;
        color: var(--spd-red);
    }
    
    .progress {
        background: linear-gradient(to right, #ffebee, #ffcdd2);
        height: 25px;
    }
    
    .progress-bar {
        background: linear-gradient(to right, var(--spd-red), var(--spd-dark-red));
        transition: width 0.6s ease;
    }
    
    .progress-tooltip {
        position: relative;
        cursor: help;
    }
    
    .progress-tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 0.5rem;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border-radius: 4px;
        font-size: 0.875rem;
        white-space: nowrap;
        z-index: 1000;
    }

    /* Timeline Styles */
    .timeline {
        position: relative;
        padding: 20px 0;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        height: 100%;
        background: var(--spd-light-gray);
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 30px;
    }
    
    .timeline-content {
        position: relative;
        width: calc(50% - 30px);
        padding: 15px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .timeline-item:nth-child(odd) .timeline-content {
        margin-left: auto;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--spd-red);
        z-index: 1;
    }
    
    .timeline-date {
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: var(--spd-dark-red);
    }
    
    .timeline-slot {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        background: var(--spd-light-gray);
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }
    
    .timeline-status {
        position: absolute;
        top: 15px;
        right: 15px;
    }
    
    @media (max-width: 768px) {
        .timeline::before {
            left: 30px;
        }
        
        .timeline-content {
            width: calc(100% - 60px);
            margin-left: 60px !important;
        }
        
        .timeline-item::before {
            left: 30px;
        }
    }

    /* Form Wizard Styles */
    .form-wizard {
        position: relative;
    }
    
    .wizard-step {
        display: none;
    }
    
    .wizard-step.active {
        display: block;
    }
    
    .wizard-progress {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }
    
    .wizard-progress::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--spd-light-gray);
        z-index: 1;
    }
    
    .progress-step {
        position: relative;
        z-index: 2;
        background: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid var(--spd-light-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .progress-step.active {
        border-color: var(--spd-red);
        background: var(--spd-red);
        color: white;
    }
    
    .progress-step.completed {
        border-color: var(--spd-red);
        background: white;
        color: var(--spd-red);
    }
    
    .wizard-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
    }
    
    /* Date Picker Styles */
    .date-picker {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 1rem;
    }
    
    .date-option {
        padding: 10px;
        border: 2px solid var(--spd-light-gray);
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .date-option:hover {
        border-color: var(--spd-red);
    }
    
    .date-option.selected {
        background: var(--spd-red);
        border-color: var(--spd-red);
        color: white;
    }
    
    .time-slot-picker {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 10px;
        margin-bottom: 1rem;
    }
    
    .time-slot-option {
        padding: 10px;
        border: 2px solid var(--spd-light-gray);
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .time-slot-option:hover {
        border-color: var(--spd-red);
    }
    
    .time-slot-option.selected {
        background: var(--spd-red);
        border-color: var(--spd-red);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Routendetails -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="route-detail-card">
                        <div class="route-header">
                            <h1>{{ route.street }}</h1>
                            <p>{{ route.house_numbers }}, {{ route.zip_code }} {{ route.city }}</p>
                        </div>

                        <div class="route-stats">
                            <div class="index-container">
                                <div class="index-label">
                                    <i class="fas fa-bullhorn index-icon" title="Mobilisierungsindex"></i>
                                    <strong>Mobilisierung</strong>
                                </div>
                                <div class="progress progress-tooltip" 
                                     data-tooltip="Zeigt an, wie gut sich die Route für Mobilisierung eignet ({{ route.mobilization_index }}/3)">
                                    <div class="progress-bar" 
                                         role="progressbar" 
                                         style="width: {{ (route.mobilization_index/3*100)|round }}%">
                                        {{ route.mobilization_index }}/3
                                    </div>
                                </div>
                            </div>
                            <div class="index-container">
                                <div class="index-label">
                                    <i class="fas fa-handshake index-icon" title="Überzeugungsindex"></i>
                                    <strong>Überzeugung</strong>
                                </div>
                                <div class="progress progress-tooltip"
                                     data-tooltip="Zeigt an, wie hoch das Überzeugungspotenzial in dieser Route ist ({{ route.conviction_index }}/3)">
                                    <div class="progress-bar" 
                                         role="progressbar" 
                                         style="width: {{ (route.conviction_index/3*100)|round }}%">
                                        {{ route.conviction_index }}/3
                                    </div>
                                </div>
                            </div>
                            {% if route.households %}
                            <div class="stat-card">
                                <h3>Haushalte</h3>
                                <p>{{ route.households }}</p>
                            </div>
                            {% endif %}
                            {% if route.rental_percentage %}
                            <div class="stat-card">
                                <h3>Mietquote</h3>
                                <p>{{ "%.1f"|format(route.rental_percentage) }}%</p>
                            </div>
                            {% endif %}
                        </div>

                        <div class="highlight-box">
                            <h5><i class="fas fa-route text-primary"></i> Routendetails</h5>
                            <p class="lead">
                                Diese Route wurde für Jan Dierens Haustürwahlkampf 2025 optimiert.
                                Sie umfasst {{ route.house_numbers }} und ist für einen 2-stündigen Einsatz im Zweierteam ausgelegt.
                                Gemeinsam sprechen wir mit den Menschen über bezahlbares Wohnen, gute Arbeit und die Zukunft unserer Region.
                            </p>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-clock text-info"></i> Zeitbedarf: 2 Stunden
                                        </li>
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-door-open text-success"></i> Geplante Gespräche: 10-15 Haushalte
                                        </li>
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-walking text-primary"></i> Empfohlene Gehrichtung: 
                                            <br>von {{ route.house_numbers.split('-')[0] }} 
                                            bis {{ route.house_numbers.split('-')[1] }}
                                        </li>
                                        {% if route.meeting_point %}
                                        <li class="list-group-item bg-transparent">
                                            <i class="fas fa-map-marker-alt text-danger"></i> Treffpunkt: 
                                            <br>{{ route.meeting_point }}
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-3">Beste Besuchszeiten:</h6>
                                    <span class="time-slot-badge">
                                        <i class="fas fa-sun"></i> Werktags 17-19 Uhr
                                    </span>
                                    <span class="time-slot-badge">
                                        <i class="fas fa-coffee"></i> Samstags 11-13 Uhr
                                    </span>
                                    <div class="mt-4">
                                        <p class="text-muted">
                                            <i class="fas fa-info-circle"></i> 
                                            Du erhältst vor deinem Einsatz eine kurze Einführung und alle wichtigen Materialien. 
                                            Jan wird regelmäßig selbst mit dabei sein!
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="registration-section">
                            <h2>Registrierungen</h2>
                            {% if registrations %}
                            <div class="timeline">
                                {% for reg in registrations|sort(attribute='date') %}
                                <div class="timeline-item">
                                    <div class="timeline-content">
                                        <div class="timeline-date">
                                            {{ reg.date.strftime('%d.%m.%Y') }}
                                        </div>
                                        <div class="timeline-slot">
                                            <i class="far fa-clock"></i> {{ reg.time_slot }}
                                        </div>
                                        <div class="timeline-volunteer">
                                            <i class="far fa-user"></i> {{ reg.volunteer.name }}
                                        </div>
                                        <span class="badge timeline-status 
                                            {% if reg.status == 'geplant' %}bg-warning
                                            {% elif reg.status == 'abgeschlossen' %}bg-success
                                            {% else %}bg-danger{% endif %}">
                                            {{ reg.status }}
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-muted">Noch keine Registrierungen für diese Route.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Google Maps Container -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="map-container" id="mapContainer">
                        <div id="map" style="width: 100%; height: 100%;"></div>
                        <div class="map-controls">
                            <button class="map-control-btn" id="fullscreenBtn" title="Vollbild">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="map-control-btn" id="zoomInBtn" title="Vergrößern">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="map-control-btn" id="zoomOutBtn" title="Verkleinern">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Aktionsbuttons -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">Aktionen</h5>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registrationModal">
                            Route reservieren
                        </button>
                        <button class="btn btn-outline-secondary" onclick="window.history.back()">
                            Zurück zur Übersicht
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="loading-spinner"></div>

<!-- Toast Container -->
<div class="toast-container">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Mitteilung</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Schließen"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

<!-- Registrierungs-Modal -->
<div class="modal" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registrationModalLabel">Route reservieren</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <form id="registrationForm" class="form-wizard">
                    <div class="wizard-progress">
                        <div class="progress-step active" data-step="1">1</div>
                        <div class="progress-step" data-step="2">2</div>
                        <div class="progress-step" data-step="3">3</div>
                    </div>
                    
                    <!-- Schritt 1: Persönliche Daten -->
                    <div class="wizard-step active" data-step="1">
                        <h6 class="mb-3">Persönliche Daten</h6>
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" required 
                                   pattern="[A-Za-zÄäÖöÜüß\s-]{2,50}" 
                                   title="Bitte geben Sie einen gültigen Namen ein (2-50 Zeichen)">
                            <div class="invalid-feedback">
                                Bitte geben Sie einen gültigen Namen ein (2-50 Zeichen).
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">E-Mail</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                            <div class="invalid-feedback">
                                Bitte geben Sie eine gültige E-Mail-Adresse ein.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Telefon (optional)</label>
                            <input type="tel" class="form-control" id="phone" name="phone" 
                                   pattern="[0-9+\s-]{6,20}">
                            <div class="invalid-feedback">
                                Bitte geben Sie eine gültige Telefonnummer ein.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schritt 2: Datum wählen -->
                    <div class="wizard-step" data-step="2">
                        <h6 class="mb-3">Datum wählen</h6>
                        <div class="date-picker" id="datePicker">
                            <!-- Wird dynamisch gefüllt -->
                        </div>
                        <input type="hidden" id="date" name="date" required>
                    </div>
                    
                    <!-- Schritt 3: Zeitfenster wählen -->
                    <div class="wizard-step" data-step="3">
                        <h6 class="mb-3">Zeitfenster wählen</h6>
                        <div class="time-slot-picker">
                            <div class="time-slot-option" data-value="17-19 Uhr">
                                <i class="far fa-clock"></i> Werktags 17-19 Uhr
                            </div>
                            <div class="time-slot-option" data-value="11-13 Uhr">
                                <i class="far fa-clock"></i> Samstags 11-13 Uhr
                            </div>
                        </div>
                        <input type="hidden" id="timeSlot" name="timeSlot" required>
                    </div>
                    
                    <div class="wizard-buttons">
                        <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                            Zurück
                        </button>
                        <button type="button" class="btn btn-primary" id="nextBtn">
                            Weiter
                        </button>
                        <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Reservieren
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Konstanten
    const MAP_DEFAULT_LAT = 51.4512;
    const MAP_DEFAULT_LON = 6.6382;
    const TOAST_DURATION = 5000;
    const FORM_SUBMISSION_DELAY = 300;

    // Map Variablen
    let map;
    let directionsService;
    let directionsRenderer;
    let registrationModal;
    let notificationToast;

    // Event Listener für DOM-Laden
    document.addEventListener('DOMContentLoaded', function() {
        initializeComponents();
        setupEventListeners();
    });

    // Komponenten initialisieren
    function initializeComponents() {
        // Modal ohne statische Optionen initialisieren
        const modalElement = document.getElementById('registrationModal');
        registrationModal = new bootstrap.Modal(modalElement, {
            backdrop: false,
            keyboard: true
        });

        // Event-Listener für Modal-Schließen
        modalElement.addEventListener('hidden.bs.modal', function () {
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        });

        // Toast initialisieren
        notificationToast = new bootstrap.Toast(document.getElementById('notificationToast'), {
            autohide: true,
            delay: TOAST_DURATION
        });
    }

    // Event Listener einrichten
    function setupEventListeners() {
        // Form-Handler
        const form = document.getElementById('registrationForm');
        form.addEventListener('submit', handleRegistration);

        // Modal Events
        document.getElementById('registrationModal').addEventListener('hidden.bs.modal', handleModalHidden);
        
        // Input Validation
        form.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('input', () => validateInput(input));
        });
    }

    // Input Validierung
    function validateInput(input) {
        if (input.validity.valid) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
        } else {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
        }
    }

    // Form Validierung
    function validateForm(form) {
        let isValid = true;
        form.querySelectorAll('input, select').forEach(input => {
            if (!input.validity.valid) {
                isValid = false;
                input.classList.add('is-invalid');
            }
        });
        return isValid;
    }

    // Modal verstecken Event Handler
    function handleModalHidden() {
        const form = document.getElementById('registrationForm');
        form.reset();
        form.querySelectorAll('.is-invalid, .is-valid').forEach(input => {
            input.classList.remove('is-invalid', 'is-valid');
        });
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    }

    // Toast Benachrichtigung anzeigen
    function showNotification(message, type = 'success') {
        const toast = document.getElementById('notificationToast');
        toast.querySelector('.toast-body').textContent = message;
        toast.classList.remove('bg-success', 'bg-danger');
        toast.classList.add(type === 'success' ? 'bg-success' : 'bg-danger');
        notificationToast.show();
    }

    // Registrierungs-Handler
    async function handleRegistration(event) {
        event.preventDefault();
        const form = event.target;
        
        // Form validieren
        if (!validateForm(form)) {
            return;
        }

        // UI-Elemente aktualisieren
        const submitButton = form.querySelector('button[type="submit"]');
        const spinner = submitButton.querySelector('.spinner-border');
        submitButton.disabled = true;
        spinner.classList.remove('d-none');

        const formData = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            date: document.getElementById('date').value,
            time_slot: document.getElementById('timeSlot').value,
            route_id: {{ route.id }}
        };

        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                // Modal manuell schließen
                const modalElement = document.getElementById('registrationModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                modal.hide();
                
                // Backdrop und Klassen entfernen
                document.body.classList.remove('modal-open');
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                showNotification('Registrierung erfolgreich! Sie erhalten eine Bestätigungs-E-Mail.');
                setTimeout(() => window.location.reload(), FORM_SUBMISSION_DELAY);
            } else {
                showNotification(data.error || 'Ein Fehler ist aufgetreten.', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.', 'error');
        } finally {
            submitButton.disabled = false;
            spinner.classList.add('d-none');
        }
    }

    // Map initialisieren
    function initMap() {
        const routeCenter = {
            lat: {{ route.lat|default(MAP_DEFAULT_LAT) }},
            lng: {{ route.lon|default(MAP_DEFAULT_LON) }}
        };
        
        try {
            setupMap(routeCenter);
            setupRouteMarker(routeCenter);
            setupMeetingPoint();
            setupDirections();
            setupMapControls();
        } catch (error) {
            console.error('Error initializing map:', error);
            showNotification('Fehler beim Laden der Karte.', 'error');
        }
    }

    // Map Setup
    function setupMap(center) {
        const mapOptions = {
            zoom: 15,
            center: center,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            styles: [{
                featureType: "poi",
                elementType: "labels",
                stylers: [{ visibility: "off" }]
            }]
        };
        
        map = new google.maps.Map(document.getElementById('map'), mapOptions);
    }

    // Route Marker Setup
    function setupRouteMarker(position) {
        const routeMarker = new google.maps.Marker({
            position: position,
            map: map,
            title: '{{ route.street }}',
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: "#E3000F",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "#ffffff"
            }
        });

        const routeInfo = new google.maps.InfoWindow({
            content: `
                <div style="padding: 10px;">
                    <h6 style="color: #A41D21; margin-bottom: 5px;">{{ route.street }}</h6>
                    <p style="margin: 0;">{{ route.house_numbers }}, {{ route.zip_code }} {{ route.city }}</p>
                </div>
            `
        });

        routeMarker.addListener('click', () => routeInfo.open(map, routeMarker));
    }

    // Meeting Point Setup
    function setupMeetingPoint() {
        {% if route.meeting_point and route.meeting_point_lat and route.meeting_point_lon %}
        const meetingPoint = new google.maps.Marker({
            position: {
                lat: {{ route.meeting_point_lat }},
                lng: {{ route.meeting_point_lon }}
            },
            map: map,
            title: 'Treffpunkt',
            icon: {
                path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                scale: 6,
                fillColor: "#E3000F",
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: "#ffffff"
            }
        });

        const meetingPointInfo = new google.maps.InfoWindow({
            content: `
                <div style="padding: 10px;">
                    <h6 style="color: #A41D21; margin-bottom: 5px;">Treffpunkt</h6>
                    <p style="margin: 0;">{{ route.meeting_point }}</p>
                </div>
            `
        });

        meetingPoint.addListener('click', () => meetingPointInfo.open(map, meetingPoint));
        {% endif %}
    }

    // Directions Setup
    function setupDirections() {
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
                strokeColor: '#E3000F',
                strokeOpacity: 0.8,
                strokeWeight: 5
            }
        });

        const numbers = '{{ route.house_numbers }}'.split('-');
        const startNum = parseInt(numbers[0].trim(), 10);
        const endNum = parseInt(numbers[1].trim(), 10);
        const startAddress = `{{ route.street }} ${startNum}, {{ route.zip_code }} {{ route.city }}, Germany`;
        const endAddress = `{{ route.street }} ${endNum}, {{ route.zip_code }} {{ route.city }}, Germany`;

        calculateRoute(startAddress, endAddress);
    }

    // Route berechnen
    function calculateRoute(startAddress, endAddress) {
        directionsService.route({
            origin: startAddress,
            destination: endAddress,
            travelMode: google.maps.TravelMode.WALKING
        }, (response, status) => {
            if (status === 'OK') {
                directionsRenderer.setDirections(response);
                const coordinates = response.routes[0].overview_path.map(point => ({
                    lat: point.lat(),
                    lng: point.lng()
                }));
                saveRouteCoordinates(coordinates);
            } else {
                console.error('Directions request failed:', status);
                showNotification('Fehler beim Laden der Route.', 'error');
            }
        });
    }

    // Route Koordinaten speichern
    async function saveRouteCoordinates(coordinates) {
        try {
            await fetch('/api/routes/{{ route.id }}/path', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ coordinates: coordinates })
            });
        } catch (error) {
            console.error('Error saving route coordinates:', error);
        }
    }

    // Karten-Kontrollen
    function setupMapControls() {
        const mapContainer = document.getElementById('mapContainer');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        
        fullscreenBtn.addEventListener('click', () => {
            mapContainer.classList.toggle('map-fullscreen');
            const icon = fullscreenBtn.querySelector('i');
            icon.classList.toggle('fa-expand');
            icon.classList.toggle('fa-compress');
            google.maps.event.trigger(map, 'resize');
        });
        
        zoomInBtn.addEventListener('click', () => {
            map.setZoom(map.getZoom() + 1);
        });
        
        zoomOutBtn.addEventListener('click', () => {
            map.setZoom(map.getZoom() - 1);
        });
    }

    // Wizard Funktionalität
    let currentStep = 1;
    const totalSteps = 3;

    function updateWizardProgress() {
        document.querySelectorAll('.progress-step').forEach(step => {
            const stepNum = parseInt(step.dataset.step);
            step.classList.remove('active', 'completed');
            if (stepNum === currentStep) {
                step.classList.add('active');
            } else if (stepNum < currentStep) {
                step.classList.add('completed');
            }
        });
    }

    function showStep(step) {
        document.querySelectorAll('.wizard-step').forEach(s => {
            s.classList.remove('active');
        });
        document.querySelector(`.wizard-step[data-step="${step}"]`).classList.add('active');
        
        // Button Sichtbarkeit
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        prevBtn.style.display = step > 1 ? 'block' : 'none';
        nextBtn.style.display = step < totalSteps ? 'block' : 'none';
        submitBtn.style.display = step === totalSteps ? 'block' : 'none';
    }

    document.getElementById('nextBtn').addEventListener('click', () => {
        if (validateCurrentStep()) {
            currentStep++;
            showStep(currentStep);
            updateWizardProgress();
        }
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
        currentStep--;
        showStep(currentStep);
        updateWizardProgress();
    });

    // Datum-Picker initialisieren
    function initDatePicker() {
        const datePicker = document.getElementById('datePicker');
        const dateInput = document.getElementById('date');
        
        // Nächste 14 Tage generieren
        const dates = [];
        for (let i = 0; i < 14; i++) {
            const date = new Date();
            date.setDate(date.getDate() + i);
            dates.push(date);
        }
        
        // Datum-Optionen erstellen
        dates.forEach(date => {
            const option = document.createElement('div');
            option.className = 'date-option';
            option.dataset.value = date.toISOString().split('T')[0];
            option.textContent = date.toLocaleDateString('de-DE', {
                weekday: 'short',
                day: '2-digit',
                month: '2-digit'
            });
            
            option.addEventListener('click', () => {
                document.querySelectorAll('.date-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                dateInput.value = option.dataset.value;
            });
            
            datePicker.appendChild(option);
        });
    }

    // Zeitfenster-Picker initialisieren
    function initTimeSlotPicker() {
        const timeSlotInput = document.getElementById('timeSlot');
        document.querySelectorAll('.time-slot-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.time-slot-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                timeSlotInput.value = option.dataset.value;
            });
        });
    }

    // Validierung des aktuellen Schritts
    function validateCurrentStep() {
        const currentStepElement = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
        let isValid = true;
        
        if (currentStep === 1) {
            // Validiere persönliche Daten
            currentStepElement.querySelectorAll('input[required]').forEach(input => {
                if (!input.validity.valid) {
                    isValid = false;
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                }
            });
        } else if (currentStep === 2) {
            // Validiere Datum
            const dateInput = document.getElementById('date');
            if (!dateInput.value) {
                isValid = false;
                showNotification('Bitte wählen Sie ein Datum aus.', 'error');
            }
        } else if (currentStep === 3) {
            // Validiere Zeitfenster
            const timeSlotInput = document.getElementById('timeSlot');
            if (!timeSlotInput.value) {
                isValid = false;
                showNotification('Bitte wählen Sie ein Zeitfenster aus.', 'error');
            }
        }
        
        return isValid;
    }

    // Initialisierung
    document.addEventListener('DOMContentLoaded', () => {
        initDatePicker();
        initTimeSlotPicker();
        updateWizardProgress();
    });
</script>
{% endblock %} 